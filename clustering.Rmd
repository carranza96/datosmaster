---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
library(ggplot2)
library(dplyr)
library(caret)
library(cluster)
library(klaR)
library(clustMixType)
library(data.table)
library(factoextra)
```


# Data preprocessing


```{r}
BlackFriday <- read.csv("BlackFriday.csv")
dim(BlackFriday)
head(BlackFriday)
```


Check for columns with NaN values

```{r}
colnames(BlackFriday)[ apply(BlackFriday, 2, anyNA) ]
```


Fill empty Product_Category with zeros

```{r}
# BlackFriday[is.na(BlackFriday)] <- 0
```


Factorize categorical columns
```{r}
BlackFriday$Occupation <- factor(BlackFriday$Occupation)
BlackFriday$Marital_Status <- factor(BlackFriday$Marital_Status)
BlackFriday$Product_Category_1 <- factor(BlackFriday$Product_Category_1)
BlackFriday$Product_Category_2 <- factor(BlackFriday$Product_Category_2)
BlackFriday$Product_Category_3 <- factor(BlackFriday$Product_Category_3)
```


Create dataframe without User_ID,Product_ID

```{r}
BlackFriday_Clustering <- BlackFriday
BlackFriday_Clustering$User_ID <- NULL
BlackFriday_Clustering$Product_ID <- NULL
head(BlackFriday_Clustering)
```




# Version 1: K-means with binarized attributes (one-hot encoding)

Dummy vars to binarize attributes
```{r}
dmy <- dummyVars(" ~ .", data = BlackFriday_Clustering)
BlackFriday_ohe <- data.frame(predict(dmy, newdata = BlackFriday_Clustering))
BlackFriday_ohe[is.na(BlackFriday_ohe)] <- 0
```


Unify product categories
```{r}
for (i in 1:18){
  new_colname <- paste("Product_Category_",i,sep="")
  regex <- paste("Product_Category_..",i,"$",sep="")
  cols_to_join <- grep( regex, names(BlackFriday_ohe),value=T)
  cols <- BlackFriday_ohe[ , cols_to_join ]
  if(is.list(cols)){
    BlackFriday_ohe[new_colname] <- do.call(pmax, cols)
  }
  else{
    BlackFriday_ohe[new_colname] <- cols
  }
  BlackFriday_ohe[ , cols_to_join ] <- NULL
}
```


Delete one of the columns of variables with only two values (Gender and Marital_Status)
```{r}
BlackFriday_ohe$Gender.F <- NULL
BlackFriday_ohe$Marital_Status.0 <- NULL
```


Normalize Purchase column
```{r}
normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
}
max_purchase <- max(BlackFriday_ohe["Purchase"])
BlackFriday_ohe$Purchase <- c(apply(BlackFriday_ohe["Purchase"], 2,normalize))

```



Visualize transformed DataFrame
```{r}
head(BlackFriday_ohe)
```


Optimal number of clusters (total within-cluster sum of square (wss))
```{r}
# wss <- 0
# for (i in 1:15) {
#   km.out <- kmeans(BlackFriday_ohe, centers = i, nstar=5)
#   wss[i] <- km.out$tot.withinss
# }
# plot(1:15, wss, type = "b", xlab = "Number of Clusters",
#      ylab = "Within groups sum of squares")
```


Optimal number of clusters (average silhouette approach) Not working very large dataset
```{r}
# k.max <- 6
# sil <- rep(0, k.max)
# 
# # Compute the average silhouette width for 
# # k = 2 to k = 15
# for(i in 2:k.max){
#   km.res <- kmeans(BlackFriday_ohe, centers = i, nstart = 5)
#   ss <- silhouette(km.res$cluster, dist(BlackFriday_ohe))
#   sil[i] <- mean(ss[, 3])
# }
# 
# # Plot the  average silhouette width
# plot(1:k.max, sil, type = "b", pch = 19, 
#      frame = FALSE, xlab = "Number of clusters k")
# abline(v = which.max(sil), lty = 2)
```


Three clusters

```{r}
reskm <- kmeans(BlackFriday_ohe, centers = 3, nstar=5)
reskm$tot.withinss
```

```{r}
BlackFriday_Clustering$cluster <- reskm$cluster
```


```{r}
km_results <- BlackFriday_Clustering %>%
  mutate(cluster=reskm$cluster) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))
km_results$the_summary
```



```{r}
plot(BlackFriday_Clustering$cluster,BlackFriday_Clustering$Purchase)
```


Trying to characterize the clusters obtained by visualizing the distribution of values of the attributes

```{r}
k <- 3
for (i in 1:k){
  par(mfrow = c(3, 3))
  x <- BlackFriday_Clustering[BlackFriday_Clustering$cluster==i,]
  # bwplot(x$Purchase, main="Purchase")
  pie(table(x['Gender']), main="Gender")
  pie(table(x['Age']), main="Age")
  pie(table(x['Occupation']), main="Occupation")
  pie(table(x['City_Category']), main="City_Category")
  pie(table(x['Stay_In_Current_City_Years']), main="Stay_In_Current_City_Years")
  pie(table(x['Marital_Status']), main="Marital_Status")
  product_count <- 0
  for (i in 1:18){
    pc <- sum(table(x['Product_Category_1'])[paste(i)],
        if (!is.na(table(x['Product_Category_2'])[paste(i)])) (table(x['Product_Category_2'])[paste(i)]) else 0,
        if (!is.na(table(x['Product_Category_3'])[paste(i)])) (table(x['Product_Category_3'])[paste(i)]) else 0)
    product_count[i]<- pc
  }
  plot(product_count,type='h', main='Product Categories', xlab='Category', ylab='Count')
}
# pie(product_count)


# plot(table(x['Occupation']), main="Occupation")

# plot(BlackFriday_Clustering$Gender)
```



```{r}
# km_results$the_summary[[1]]
# summary(BlackFriday)[,1]
# as.numeric(sub('.*:', '', summary(BlackFriday)[1,2]))
# table(BlackFriday$Gender)
```

```{r}
fviz_cluster(reskm, geom = "point", data = BlackFriday_ohe) +  ggtitle("k = 3")
clusplot(wine.stand, k.means.fit$cluster, main='2D representation of the Cluster solution',
         color=TRUE, shade=TRUE,
         labels=2, lines=0)
```


```{r}
plot(BlackFriday_Clustering$Age,BlackFriday$Purchase, col=reskm$cluster, main="Tres clusters")

```


```{r}
k <- 5
pam_fit <- pam(gower_dist, diss = TRUE, k)
pam_fit
pam_results <- df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))
pam_results$the_summary
```




```{r}
res <- kproto(BlackFriday_Clustering,3)
res

```



```{r}
vars <- select(BlackFriday_Clustering,Occupation,Purchase)
res <- kmeans(vars,centers = 3, nstart = 20)
summary(res)
res$centers
```



