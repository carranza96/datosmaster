---
title: "EDA Black Friday"
output:
  html_document:
    df_print: paged
    toc: true
---

Empezaremos realizando un EDA con nuestro set de datos.
Importamos las librerías necesarias.

```{r results='hide',message=FALSE}
#install.packages("tidyverse")
library(tidyverse)
library(scales)
library(arules)
library(gridExtra)
library(dplyr)
```

Cargamos el dataset y lo inspeccionamos un poco.
```{r}
dataset = read.csv("BlackFriday.csv")
dim(dataset)
summary(dataset)
head(dataset)
```


Procedemos al análisis por los distintos atributos. 

# Género

Comenzamos con el género. Para esto primero agrupamos todas las transacciones que pertenezcan por User_ID, para así conocer la distribución total.

```{r}
dataset_gender = dataset %>%
                    dplyr::select(User_ID, Gender) %>%
                    group_by(User_ID) %>%
                    arrange(User_ID) %>%
                    distinct()  
                    
head(dataset_gender)

summary(dataset_gender$Gender)
```
Mostramos gráficamente la distribución.

```{r}
options(scipen=10000)   # To remove scientific numbering

genderDist  = ggplot(data = dataset_gender) +
                geom_bar(mapping = aes(x = Gender, y = ..count.., fill = Gender)) +
                labs(title = 'Género de los consumidores') 
print(genderDist)
```

Como podemos observar, aproximadamente dos tercios de las compras han sido realizadas por hombres. 

A continuación, vamos a ver si el gasto total esté relacionado con el género del consumidor.

```{r}
total_purchase_user = dataset %>%
                        dplyr::select(User_ID, Gender, Purchase) %>%
                        group_by(User_ID) %>%
                        arrange(User_ID) %>%
                        summarise(Total_Purchase = sum(Purchase))

user_purchase_gender = full_join(total_purchase_user, dataset_gender, by = "User_ID")
head(user_purchase_gender)
```

```{r}
average_spending_gender = user_purchase_gender %>%
                            group_by(Gender) %>%
                            dplyr::summarize(Purchase = sum(as.numeric(Total_Purchase)), 
                                      Count = n(), 
                                      Average = Purchase/Count)
head(average_spending_gender)
```

Como vemos, el gasto medio total por consumidor es menor en el caso de las mujeres, vamos a representarlo gráficamente.
```{r}
genderAverage  = ggplot(data = average_spending_gender) +
                    geom_bar(mapping = aes(x = Gender, y = Average, fill = Gender), stat = 'identity') +
                    labs(title = 'Gasto medio por género')
print(genderAverage)
```

# Productos más vendidos

A continuación, vamos a examinar los productos más vendidos.

```{r}
top_sellers = dataset %>%
                count(Product_ID, sort = TRUE)

top_5 = head(top_sellers, 5)

top_5
```

Tomemos el producto más vendido.

```{r}
best_seller = dataset[dataset$Product_ID == 'P00265242', ]

head(best_seller)
```

Podemos observar que el precio pagado en cada transacción (columna "Purchase") es diferente, supondremos que es por distintas ofertas. 

Combinemos estos datos con el análisis por género:

```{r}
genderDist_bs  = ggplot(data = best_seller) +
                  geom_bar(mapping = aes(x = Gender, y = ..count.., fill = Gender)) +
                  labs(title = 'Género de los consumidores (Producto más vendido)')
print(genderDist_bs)
```

Comprobemos si esta distribución coincide con los datos generales.

```{r}
genderDist_bs_prop = ggplot(data = best_seller) + 
                          geom_bar(fill = 'lightblue', mapping = aes(x = Gender, y = ..prop.., group = 1, fill = Gender)) +
                          labs(title = 'Género de los consumidores (Proporción del producto más vendido)') +
                          theme(plot.title = element_text(size=9.5))

genderDist_prop = ggplot(data = dataset_gender) + 
                      geom_bar(fill = "lightblue4", mapping = aes(x = Gender, y = ..prop.., group = 1)) +
                      labs(title = 'Género de los consumidores (Proporción total)') +
                      theme(plot.title = element_text(size=9.5)) 

grid.arrange(genderDist_prop, genderDist_bs_prop, ncol=2)
```

Podemos ver que sí, la diferencia no es representativa y este producto parece tener una distribución normal. Hagamos lo mismo con los dos siguientes productos más vendidos.

```{r}
best_seller2 = dataset[dataset$Product_ID == 'P00110742', ]
genderDist_bs_prop2 = ggplot(data = best_seller2) + 
                          geom_bar(fill = 'lightblue', mapping = aes(x = Gender, y = ..prop.., group = 1, fill = Gender)) +
                          labs(title = 'Género de los consumidores (Proporción del segundo producto más vendido)') +
                          theme(plot.title = element_text(size=9.5))

grid.arrange(genderDist_prop, genderDist_bs_prop2, ncol=2)
```

```{r}
best_seller3 = dataset[dataset$Product_ID == 'P00025442', ]
genderDist_bs_prop3 = ggplot(data = best_seller3) + 
                          geom_bar(fill = 'lightblue', mapping = aes(x = Gender, y = ..prop.., group = 1, fill = Gender)) +
                          labs(title = 'Género de los consumidores (Proporción del tercer producto más vendido)') +
                          theme(plot.title = element_text(size=9.5))

grid.arrange(genderDist_prop, genderDist_bs_prop3, ncol=2)
```

En estos dos casos observamos que las mujeres compran algo menos estos productos (~7%).

# Edad

Pasemos a analizar la edad.

```{r}
customers_age = dataset %>%
                    dplyr::select(User_ID, Age) %>%
                    distinct() %>%
                    count(Age)

customers_age_vis = ggplot(data = customers_age) + 
                      geom_bar(color = 'black', stat = 'identity', mapping = aes(x = Age, y = n, fill = Age)) +
                      labs(title = 'Edad de los consumidores') +
                      theme(axis.text.x = element_text(size = 10)) +
                      scale_fill_brewer(palette = 'Blues') +
                      theme(legend.position="none")
print(customers_age_vis)
```

Usemos esta distribución para ver si existe un grupo que compre más alguno de nuestros productos más vendidos.

```{r}
ageDist_bs  = ggplot(data = best_seller) +
                  geom_bar(color = 'black', mapping = aes(x = Age, y = ..count.., fill = Age)) +
                  labs(title = 'Edad de los consumidores (producto más vendido)') +
                  theme(axis.text.x = element_text(size = 10)) +
                  scale_fill_brewer(palette = 'GnBu') + 
                  theme(legend.position="none")

grid.arrange(customers_age_vis, ageDist_bs, ncol=2)
```

```{r}
ageDist_bs2  = ggplot(data = best_seller2) +
                  geom_bar(color = 'black', mapping = aes(x = Age, y = ..count.., fill = Age)) +
                  labs(title = 'Edad de los consumidores (segundo producto más vendido)') +
                  theme(axis.text.x = element_text(size = 10)) +
                  scale_fill_brewer(palette = 'GnBu') + 
                  theme(legend.position="none")

grid.arrange(customers_age_vis, ageDist_bs2, ncol=2)
```

```{r}
ageDist_bs3  = ggplot(data = best_seller3) +
                  geom_bar(color = 'black', mapping = aes(x = Age, y = ..count.., fill = Age)) +
                  labs(title = 'Edad de los consumidores (tercer producto más vendido)') +
                  theme(axis.text.x = element_text(size = 10)) +
                  scale_fill_brewer(palette = 'GnBu') + 
                  theme(legend.position="none")

grid.arrange(customers_age_vis, ageDist_bs3, ncol=2)
```

Podemos observar que nuestros artículos más vendidos suelen ser más populares entre los consumidores más jóvenes, sobre todo el Top1, que concentra sus ventas en las franjas 18-25 y 26-35.

# Ciudades

Sigamos analizando con las ciudades.

```{r}
customers_location =  dataset %>%
                            dplyr::select(User_ID, City_Category) %>%
                            distinct()

customers_location_vis = ggplot(data = customers_location) +
                          geom_bar(color = 'white', mapping = aes(x = City_Category, y = ..count.., fill = City_Category)) +
                          labs(title = 'Localización de los consumidores') + 
                          scale_fill_brewer(palette = "Dark2") + 
                          theme(legend.position="none")
print(customers_location_vis)
```

Vemos que la mayoría de consumidores se encuentran en la ciudad C. Veamos ahora el volumen de venta (en miles) por ciudad.

```{r}
purchases_city = dataset %>%
                  group_by(City_Category) %>%
                  summarise(Purchases = sum(Purchase))

purchases_city_1000s = purchases_city %>%
                          mutate(purchasesThousands = purchases_city$Purchases / 1000)

purchaseCity_vis = ggplot(data = purchases_city_1000s, aes(x = City_Category, y = purchasesThousands, fill = City_Category)) +
                      geom_bar(color = 'white', stat = 'identity') +
                      labs(title = 'Cantidad total de venta (por ciudad)', y = '($000s)', x = 'City Category') +
                      scale_fill_brewer(palette = "Dark2") + 
                      theme(legend.position="none", plot.title = element_text(size = 9))

grid.arrange(customers_location_vis, purchaseCity_vis, ncol=2)

purchases_city_1000s
```

Con esto comprobamos que el volumen de ventas es mayor en la ciudad B.

```{r}
customers = dataset %>%
              group_by(User_ID) %>%
              count(User_ID)

customers_City =  dataset %>%
                    dplyr::select(User_ID, City_Category) %>%
                    group_by(User_ID) %>%
                    distinct() %>%
                    ungroup() %>%
                    left_join(customers, customers_City, by = 'User_ID') 

city_purchases_count = customers_City %>%
                        dplyr::select(City_Category, n) %>%
                        group_by(City_Category) %>%
                        summarise(CountOfPurchases = sum(n))

city_count_purchases_vis = ggplot(data = city_purchases_count, aes(x = City_Category, y = CountOfPurchases, fill = City_Category)) +
                              geom_bar(color = 'white', stat = 'identity') +
                              labs(title = 'Ventas totales (por ciudad)', y = 'Count', x = 'City Category') +
                              scale_fill_brewer(palette = "Dark2") +
                              theme(legend.position="none", plot.title = element_text(size = 9))

grid.arrange(purchaseCity_vis, city_count_purchases_vis, ncol = 2)
```

Comparando ambas gráficas podemos ver que la mayor cantidad total de venta se corresponde correctamente con el mayor volumen de ventas totales en la ciudad B. Procedemos a analizar las ventas de los productos más vendidos.

```{r}
best_seller_city = best_seller %>%
                    dplyr::select(User_ID, City_Category) %>%
                    distinct() %>%
                    count(City_Category)

best_seller_city_vis = ggplot(data = best_seller_city, aes(x = City_Category, y = n, fill = City_Category)) +
                              geom_bar(color = 'white', stat = 'identity') +
                              labs(title = 'Número total de Ventas del artículo mejor vendido (por ciudad)', y = 'Count', x = 'City Category') +
                              scale_fill_brewer(palette = "Blues") +
                              theme(legend.position="none", plot.title = element_text(size = 9))
grid.arrange(city_count_purchases_vis,best_seller_city_vis, ncol = 2)
```

```{r}
best_seller_city2 = best_seller2 %>%
                    dplyr::select(User_ID, City_Category) %>%
                    distinct() %>%
                    count(City_Category)

best_seller_city_vis2 = ggplot(data = best_seller_city2, aes(x = City_Category, y = n, fill = City_Category)) +
                              geom_bar(color = 'white', stat = 'identity') +
                              labs(title = 'Número total de Ventas del segundo artículo mejor vendido (por ciudad)', y = 'Count', x = 'City Category') +
                              scale_fill_brewer(palette = "Blues") +
                              theme(legend.position="none", plot.title = element_text(size = 9))
grid.arrange(city_count_purchases_vis,best_seller_city_vis2, ncol = 2)
```

```{r}
best_seller_city3 = best_seller3 %>%
                    dplyr::select(User_ID, City_Category) %>%
                    distinct() %>%
                    count(City_Category)

best_seller_city_vis3 = ggplot(data = best_seller_city3, aes(x = City_Category, y = n, fill = City_Category)) +
                              geom_bar(color = 'white', stat = 'identity') +
                              labs(title = 'Número total de Ventas del tercer artículo mejor vendido (por ciudad)', y = 'Count', x = 'City Category') +
                              scale_fill_brewer(palette = "Blues") +
                              theme(legend.position="none", plot.title = element_text(size = 9))
grid.arrange(city_count_purchases_vis,best_seller_city_vis3, ncol = 2)
```

Curiosamente, la mayoría de las ventas de los artículos más vendidos se realizan en la ciudad C.

Continuamos estudiando la distribución de los compradores que han vivido durante más tiempo en la ciudad.

```{r}
customers_stay = dataset %>%
                    dplyr::select(User_ID, City_Category, Stay_In_Current_City_Years) %>%
                    group_by(User_ID) %>%
                    distinct()

residence = customers_stay %>%
                group_by(City_Category) %>%
                tally()

head(residence)
```

Comprobamos que la mayoría de los compradores viven en la ciudad C.

```{r}
stay_cities = customers_stay %>%
                group_by(City_Category, Stay_In_Current_City_Years) %>%
                tally() %>%
                mutate(Percentage = (n/sum(n))*100)

ggplot(data = stay_cities, aes(x = City_Category, y = n, fill = Stay_In_Current_City_Years)) + 
    geom_bar(stat = "identity", color = 'white') + 
    labs(title = "Ciudad + años en la ciudad", 
            y = "Total Count (Years)", 
            x = "City", 
            fill = "Stay Years")
```

En esta gráfica observamos como la mayoría de los consumidores de cada ciudad han estado viviendo 1 año en ella.

# Valor Compras

Continuamos analizando el valor de las compras.

```{r warning=FALSE}
customers_total_purchase_amount = dataset %>%
                                    group_by(User_ID) %>%
                                    summarise(Purchase_Amount = sum(Purchase))

customers_total_purchase_amount = arrange(customers_total_purchase_amount, desc((Purchase_Amount)))

ggplot(customers_total_purchase_amount, aes(Purchase_Amount)) +
  geom_density(adjust = 1) +
  geom_vline(aes(xintercept=median(Purchase_Amount)),
             color="blue", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=mean(Purchase_Amount)),
             color="red", linetype="dashed", size=1) +
  geom_text(aes(x=mean(Purchase_Amount), label=round(mean(Purchase_Amount)), y=1.2e-06), color = 'red', angle=360,
            size=4, vjust=3, hjust=-.1) +
  geom_text(aes(x=median(Purchase_Amount), label=round(median(Purchase_Amount)), y=1.2e-06), color = 'blue', angle=360,
            size=4, vjust=0, hjust=-.1) +
  scale_x_continuous(name="Purchase Amount", limits=c(0, 7500000), breaks = seq(0,7500000, by = 1000000), expand = c(0,0)) +
  scale_y_continuous(name="Density", limits=c(0, .00000125), labels = scientific, expand = c(0,0))
```


# Estado civil

Veamos ahora si el estado civil influye en las compras.

```{r}
dataset_maritalStatus = dataset %>%
                            dplyr::select(User_ID, Marital_Status) %>%
                            group_by(User_ID) %>%
                            distinct()

dataset_maritalStatus$Marital_Status = as.character(dataset_maritalStatus$Marital_Status)

marital_vis = ggplot(data = dataset_maritalStatus) +
                    geom_bar(mapping = aes(x = Marital_Status, y = ..count.., fill = Marital_Status)) +
                    labs(title = 'Estado civil')

print(marital_vis)
```

Al no incluirse una explicación de las columnas del set de datos suponemos que el valor 1 indica casado. Por tanto, vemos que la mayor parte de las compras han sido realizadas por solteros. Sigamos investigando como es esta proporción para cada ciudad.

```{r}
dataset_maritalStatus = dataset_maritalStatus %>%
                            full_join(customers_stay, by = 'User_ID') 

maritalStatus_cities = dataset_maritalStatus %>%
                        group_by(City_Category, Marital_Status) %>%
                        tally()

ggplot(data = maritalStatus_cities, aes(x = City_Category, y = n, fill = Marital_Status)) + 
    geom_bar(stat = "identity", color = 'black') + 
    labs(title = "Ciudad + Estado Civil", 
            y = "Total Count (Shoppers)", 
            x = "City", 
            fill = "Marital Status")
```

Podemos observar que la proporción es muy parecida en las tres ciudades, siendo un poco mayor la proporción de solteros en la ciudad A. Miremos ahora si la distribución de edades de los consumidores revela algo más.

```{r}
Users_Age = dataset %>%
                dplyr::select(User_ID, Age) %>%
                distinct()


dataset_maritalStatus = dataset_maritalStatus %>%
                            full_join(Users_Age, by = 'User_ID')

City_A = dataset_maritalStatus %>%
            filter(City_Category == 'A')
City_B = dataset_maritalStatus %>%
            filter(City_Category == 'B')
City_C = dataset_maritalStatus %>%
            filter(City_Category == 'C')

City_A_stay_vis = ggplot(data = City_A, aes(x = Age, y = ..count.., fill = Age)) + 
                              geom_bar(stat = 'count') +
                              scale_fill_brewer(palette = 8) +
                              theme(legend.position="none", axis.text = element_text(size = 6)) +
                              labs(title = 'Ciudad A', y = 'Count', x = 'Age', fill = 'Age')
City_B_stay_vis = ggplot(data = City_B, aes(x = Age, y = ..count.., fill = Age)) +
                              geom_bar(stat = 'count') +
                              scale_fill_brewer(palette = 9) +
                              theme(legend.position="none", axis.text = element_text(size = 6)) +
                              labs(title = 'Ciudad B', y = 'Count', x = 'Age', fill = 'Age')
City_C_stay_vis = ggplot(data = City_C, aes(x = Age, y = ..count.., fill = Age)) +
                              geom_bar(stat = 'count') +
                              scale_fill_brewer(palette = 11) +
                              theme(legend.position="none", axis.text = element_text(size = 6)) +
                              labs(title = 'Ciudad C', y = 'Count', x = 'Age', fill = 'Age')

grid.arrange(City_A_stay_vis, City_B_stay_vis, City_C_stay_vis, ncol = 3)
```

En estas gráficas observamos que hay una mayor cantidad de consumidores de edad menor a 45 años, esto puede ser el por qué de la mayor proporción de consumidores solteros.


De la misma forma que miramos los artículos, podemos buscar cuales son los consumidores que más han gastado.

```{r}
top_shoppers = dataset %>%
                count(User_ID, sort = TRUE)

top_shoppers =  top_shoppers %>%
                    dplyr::select(User_ID, n) %>%
                    left_join(customers_total_purchase_amount, Purchase_Amount, by = 'User_ID')

top_shoppers = mutate(top_shoppers,
                  Average_Purchase_Amount = Purchase_Amount/n)

top_shoppers_ordered = top_shoppers %>%
                          arrange(desc(Purchase_Amount))

head(top_shoppers_ordered)

```

# Ocupación

Por último, analicemos las ocupaciones para descubrir cuanto gasta cada grupo de consumidores.

```{r}
customers_Occupation =  dataset %>%
                          dplyr::select(User_ID, Occupation) %>%
                          group_by(User_ID) %>%
                          distinct() %>%
                          left_join(customers_total_purchase_amount, Occupation, by = 'User_ID')

totalPurchases_Occupation = customers_Occupation %>%
                              group_by(Occupation) %>%
                              summarise(Purchase_Amount = sum(Purchase_Amount)) %>%
                              arrange(desc(Purchase_Amount))

totalPurchases_Occupation$Occupation = as.character(totalPurchases_Occupation$Occupation)


occupation = ggplot(data = totalPurchases_Occupation) +
                  geom_bar(mapping = aes(x = reorder(Occupation, -Purchase_Amount), y = Purchase_Amount, fill = Occupation), stat = 'identity') +
                  scale_x_discrete(name="Ocupación", breaks = seq(0,20, by = 1), expand = c(0,0)) +
                  scale_y_continuous(name="Cantidad de venta ($)", expand = c(0,0), limits = c(0, 700000000)) +
                  labs(title = 'Cantidad total de ventas por ocupación') + 
                  theme(legend.position="none")

print(occupation)
```

Como vemos, los consumidores con la ocupación cuatro son los que más han gastado.